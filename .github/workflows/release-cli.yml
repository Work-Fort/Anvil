# SPDX-License-Identifier: Apache-2.0
name: Release CLI

on:
  push:
    branches:
      - master

permissions:
  contents: write  # Required for creating releases

jobs:
  tag:
    name: Create Version Tag
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag_version.outputs.new_tag }}
      changelog: ${{ steps.tag_version.outputs.changelog }}
      should_release: ${{ steps.check_tag.outputs.should_release }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for conventional commits

      - name: Bump version and create tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          release_branches: master
          pre_release_branches: develop
          tag_prefix: cli-v
          dry_run: false

      - name: Check if new tag was created
        id: check_tag
        run: |
          if [ -n "${{ steps.tag_version.outputs.new_tag }}" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build CLI (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs: tag
    if: needs.tag.outputs.should_release == 'true'

    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.tag.outputs.new_tag }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Task
        uses: go-task/setup-task@v1

      - name: Install libguestfs (required for CGO compilation)
        run: sudo apt-get update && sudo apt-get install -y libguestfs-dev

      - name: Build release binary
        env:
          TAG: ${{ needs.tag.outputs.new_tag }}
        run: |
          # Strip cli-v prefix from tag for version string (cli-v1.0.0 -> 1.0.0)
          VERSION=$(echo "$TAG" | sed 's/^cli-v//')
          task go:build:release VERSION=$VERSION GOARCH=${{ matrix.arch }}

      - name: Compress and generate checksum
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          cd build
          # Compress with xz -9 (maximum compression)
          xz -z -9 "anvil-linux-${ARCH}"
          # Generate checksum of compressed file (users verify before decompression)
          sha256sum "anvil-linux-${ARCH}.xz" > "anvil-linux-${ARCH}.sha256"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-${{ matrix.arch }}-${{ needs.tag.outputs.new_tag }}
          path: |
            build/anvil-linux-${{ matrix.arch }}.xz
            build/anvil-linux-${{ matrix.arch }}.sha256
          retention-days: 7

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [tag, build]
    if: needs.tag.outputs.should_release == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.tag.outputs.new_tag }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Task
        uses: go-task/setup-task@v1

      - name: Install libguestfs (required for CLI compilation)
        run: sudo apt-get update && sudo apt-get install -y libguestfs-dev

      - name: Build CLI
        run: task build

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: cli-*-${{ needs.tag.outputs.new_tag }}
          merge-multiple: true

      - name: Import signing key
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          printf '%s' "$SIGNING_KEY" > /tmp/signing-key.asc
          ./build/anvil signing import-key /tmp/signing-key.asc
          rm -f /tmp/signing-key.asc

      - name: Create signed checksums
        env:
          ANVIL_SIGNING_PASSWORD: ${{ secrets.ANVIL_SIGNING_PASSWORD }}
        run: |
          cd release-artifacts

          # Combine individual checksums into SHA256SUMS
          cat *.sha256 > SHA256SUMS
          rm *.sha256

          # Sign the checksums
          ../build/anvil signing sign .

          echo "Release artifacts:"
          ls -lh

      - name: Create release notes
        env:
          TAG: ${{ needs.tag.outputs.new_tag }}
          VERSION_NO_PREFIX: ${{ needs.tag.outputs.new_tag }}
          CHANGELOG: ${{ needs.tag.outputs.changelog }}
          REPO: ${{ github.repository }}
        run: |
          # Strip cli-v prefix for display (cli-v1.0.0 -> 1.0.0)
          VERSION_DISPLAY=$(echo "$TAG" | sed 's/^cli-v//')

          cat > release-notes.md << EOF
          # Anvil CLI v${VERSION_DISPLAY}

          ## What's Changed

          ${CHANGELOG}

          ## Installation

          ### Linux (x86_64)
          \`\`\`bash
          wget https://github.com/${REPO}/releases/download/${TAG}/anvil-linux-amd64.xz
          xz -d anvil-linux-amd64.xz
          chmod +x anvil-linux-amd64
          sudo mv anvil-linux-amd64 /usr/local/bin/anvil
          \`\`\`

          ### Linux (ARM64)
          \`\`\`bash
          wget https://github.com/${REPO}/releases/download/${TAG}/anvil-linux-arm64.xz
          xz -d anvil-linux-arm64.xz
          chmod +x anvil-linux-arm64
          sudo mv anvil-linux-arm64 /usr/local/bin/anvil
          \`\`\`

          ## Verification

          1. Download the appropriate binary and checksums:
          \`\`\`bash
          wget https://github.com/${REPO}/releases/download/${TAG}/anvil-linux-amd64.xz
          wget https://github.com/${REPO}/releases/download/${TAG}/SHA256SUMS
          wget https://github.com/${REPO}/releases/download/${TAG}/SHA256SUMS.asc
          wget https://github.com/${REPO}/releases/download/${TAG}/signing-key.asc
          \`\`\`

          2. Import the signing key:
          \`\`\`bash
          gpg --import signing-key.asc
          \`\`\`

          3. Verify the signature:
          \`\`\`bash
          gpg --verify SHA256SUMS.asc
          \`\`\`

          4. Verify the checksum (of compressed file):
          \`\`\`bash
          sha256sum -c SHA256SUMS --ignore-missing
          \`\`\`

          5. Decompress the binary:
          \`\`\`bash
          xz -d anvil-linux-amd64.xz
          \`\`\`

          ## Requirements

          - **libguestfs**: Required for rootfs creation
            - Ubuntu/Debian: \`sudo apt install libguestfs0\`
            - Arch Linux: \`sudo pacman -S libguestfs\`

          ## Documentation

          - [Getting Started](https://github.com/${REPO}/blob/master/README.md)
          - [CLI Documentation](https://github.com/${REPO}/tree/master/docs)

          ---

          ðŸ¤– Built automatically by [anvil](https://github.com/${REPO})
          EOF

      - name: Copy public key to release artifacts
        run: cp ~/.local/share/anvil/keys/signing-key.asc release-artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.tag.outputs.new_tag }}
          name: Release ${{ needs.tag.outputs.new_tag }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          files: |
            release-artifacts/anvil-linux-amd64
            release-artifacts/anvil-linux-arm64
            release-artifacts/SHA256SUMS
            release-artifacts/SHA256SUMS.asc
            release-artifacts/signing-key.asc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
